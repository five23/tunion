<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UNiON S0NGBOOK</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="gui">

      <div class="radioset">
        <input type="radio" name="radioSet" value="data" onmousedown="audiopen.analyserView.setAnalysisType(ANALYSISTYPE_FREQUENCY);">Frequency
        <input type="radio" name="radioSet" value="data" onmousedown="audiopen.analyserView.setAnalysisType(ANALYSISTYPE_SONOGRAM);">Sonogram
        <input type="radio" name="radioSet" value="data" checked="checked" onmousedown="audiopen.analyserView.setAnalysisType(ANALYSISTYPE_3D_SONOGRAM);">3D Sonogram
        <input type="radio" name="radioSet" value="data" onmousedown="audiopen.analyserView.setAnalysisType(ANALYSISTYPE_WAVEFORM);">Waveform
      </div>
      <canvas id="view1" width="666" height="333"></canvas>

      <div id="scopes"></div>
      <div class="fieldset">
        <canvas id="vca" nx="position" width="134" height="130"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1a" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1b" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1c" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1d" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1e" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1f" class="nx" height="130" width="130" min="0" max="1"></canvas>        
        <canvas nx="dial" style="width:65px;height:65px" id="o1g" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o1h" class="nx" height="130" width="130" min="0" max="1"></canvas>
      </div>

      <div class="fieldset">
        <canvas id="vcb" nx="position" width="134" height="130"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2a" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2b" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2c" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2d" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2e" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2f" class="nx" height="130" width="130" min="0" max="1"></canvas>        
        <canvas nx="dial" style="width:65px;height:65px" id="o2g" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o2h" class="nx" height="130" width="130" min="0" max="1"></canvas>
      </div>

      <div class="fieldset">
        <canvas id="vcc" nx="position" width="134" height="130"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o3a" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o3b" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o3c" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o3d" class="nx" height="130" width="130" min="0" max="1"></canvas>        
        <canvas nx="dial" style="width:65px;height:65px" id="o3e" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o3f" class="nx" height="130" width="130" min="0" max="1"></canvas>        
        <canvas nx="dial" style="width:65px;height:65px" id="o3g" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="o3h" class="nx" height="130" width="130" min="0" max="1"></canvas>
      </div>
      
      <div class="fieldset">      
        <canvas nx="dial" style="width:65px;height:65px" id="delayInput" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="delayFeedback" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="delayTime" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="delayGain" class="nx" height="130" width="130" min="0" max="1"></canvas>        
        <canvas nx="dial" style="width:65px;height:65px" id="delay2Input" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="delay2Feedback" class="nx" height="130" width="130" min="0" max="1"></canvas>
        <canvas nx="dial" style="width:65px;height:65px" id="delay2Time" class="nx" height="130" width="130" min="0" max="1"></canvas>                
        <canvas nx="dial" style="width:65px;height:65px" id="delay2Gain" class="nx" height="130" width="130" min="0" max="1"></canvas>
      </div>
  </div>
<div id="editor">
  const K = new kMath();
  const EPSILON = 2.2204460492503130808472633361816e-16;
  const PI = 3.1415926535897932384626433832795; // @constant {Number} pi
  const TAU = 6.283185307179586476925286766559; // @constant {Number} 2*pi
  const fs = 44100; // Process Sampling Frequency
  const fc = 111; // Center frequency
  const z1 = 0.998; // Lowpass Filter Pole (for smoothing controller changes)
  
  const omega = (TAU * fc) / fs; // Angular frequency
  
  let delay = Delay(8192);
  let delayOut = 0;
  
  function process(a) {
      
    var b = a.outputBuffer;
    //inL = a.inputBuffer.getChannelData(0);
    outL = b.getChannelData(0);
  
    for (a = 0; a < outL.length; a++) {
        
      // Filter delay controller changes
      delayInput.n = lowpass(delayInput.val.value, delayInput.n);
      delayFeedback.n = lowpass(
        delayFeedback.val.value * 0.998 + 0.01,
        delayFeedback.n
      );
      delayTime.n = lowpass(delayTime.val.value * 8000 + 192, delayTime.n);
      delayGain.n = lowpass(delayGain.val.value * 0.998 + 0.001, delayGain.n);
  
      // Osc pre gain
      a1 = lowpass(o1e.val.value, a1);
      b1 = lowpass(o2e.val.value, b1);
      c1 = lowpass(o3e.val.value, c1);
  
      // Osc post gain
      a0 = lowpass(o1d.val.value, a0);
      b0 = lowpass(o2d.val.value, b0);
      c0 = lowpass(o3d.val.value, c0);
  
      // Osc N harmonics
      aN = lowpass(vca.val.y, aN);
      bN = lowpass(vcb.val.y, bN);
      cN = lowpass(vcc.val.y, cN);
  
      // Calculate phases
      aX += vca.val.x;
      bX += vcb.val.x;
      cX += vcc.val.x;
  
      aX *= 1.000000003;
      bX *= 1.000000002;
      cX *= 0.999999998;
  
      aZ = a0 * sawtooth(omega * aX, aN + o1a.val.value * K.fBm1d(cZ));
      bZ = b0 * triangle(omega * bX, bN + o2a.val.value * K.fBm1d(aZ));
      cZ = c0 *   square(omega * cX, cN + o3a.val.value * K.fBm1d(bZ));
  
      // Mix it!
      out = 0.5 * (a1 * aZ + b1 * bZ + c1 * cZ);
  
      // Delay output (wet)
      delayOut =
        0.5 *
        delay
          .feedback(delayFeedback.n)
          .delay(delayTime.n)
          .run(delayInput.n * out);
  
      outL[a] = 0.5 * (out + delayGain.n * delayOut);
    }
  }
  
  /*
    * Digamma Function
    *
    * @param {Number} x
    * @returns {x}
    */
  const digamma = (b) => {
    let c = 0;
    if (0 >= b && b === Math.round(b)) {
      return Infinity;
    }
    if (0 > b) {
      return digamma(1.0 - b) + PI / Math.tan(-PI * b);
    }
    if (b <= EPSILON) {
      return (
        1.64493406684822643647241516664603 * b -
        1.0 / b +
        0.5772156649015328606065120900824
      );
    }
    for (; 8.0 > b; b += 1) {
      c -= 1.0 / b;
    }
    return (c +=
      Math.log(b) -
      0.5 / (b *= b) -
      (0.08333333333333333 -
        (0.008333333333333333 -
          (0.0039682539682539 - (0.004166666666666 - 1 / (132 * b)) / b) / b) /
          b) /
        b);
  };
  
  function lowpass(x, n) {
    return x + (n - x) * z1;
  }
  
  function square(x, m) {
    var a = TAU * m * Math.cos(x);
    var b = Math.cos(TAU * a);
    var c = digamma(0.75 - a) - digamma(0.25 - a);
    return 0.5 * (b * c - PI);
  }
  
  function sawtooth(x, m) {
    return Math.sin(x) * square(x, m);
  }
  
  function triangle(x, m) {
    return sawtooth(x, m) * square(x, m);
  }
  
  function Delay(size) {
    if (!(this instanceof Delay)) return new Delay(size);
    size = size || 16384;
    this.buffer = new Float32Array(size);
    this.size = size;
    this.counter = 0;
    this._feedback = 0.5;
    this._delay = 16384;
  }
  
  Delay.prototype.feedback = function (n) {
    this._feedback = n;
    return this;
  };
  
  Delay.prototype.delay = function (n) {
    this._delay = n;
    return this;
  };
  
  Delay.prototype.run = function (inp) {
    var back = this.counter - this._delay;
    if (back < 0) back = this.size + back;
    var index0 = Math.floor(back);
  
    var index_1 = index0 - 1;
    var index1 = index0 + 1;
    var index2 = index0 + 2;
  
    if (index_1 < 0) index_1 = this.size - 1;
    if (index1 >= this.size) index1 = 0;
    if (index2 >= this.size) index2 = 0;
  
    var y_1 = this.buffer[index_1];
    var y0 = this.buffer[index0];
    var y1 = this.buffer[index1];
    var y2 = this.buffer[index2];
  
    var x = back - index0;
  
    var c0 = y0;
    var c1 = 0.5 * (y1 - y_1);
    var c2 = y_1 - 2.5 * y0 + 2.0 * y1 - 0.5 * y2;
    var c3 = 0.5 * (y2 - y_1) + 1.5 * (y0 - y1);
  
    var out = ((c3 * x + c2) * x + c1) * x + c0;
  
    this.buffer[this.counter] = inp + out * this._feedback;
  
    this.counter++;
  
    if (this.counter >= this.size) this.counter = 0;
  
    return out;
  };      
        
  </div>
  <script type="text/javascript" src="js/o3djs/base.js"></script>
  <script type="text/javascript" src="js/cameracontroller.js"></script>
  <script type="text/javascript" src="js/moz/matrix4x4.js"></script>
  <script type="text/javascript" src="js/visualizer.js"></script>
  <script type="text/javascript" src="/node_modules/ace-builds/src-min/ace.js"></script>  
  <script type="text/javascript" src="/node_modules/ace-builds/src-min/worker-javascript.js"></script>
  <script type="text/javascript" src="js/alt.nexusUI.js"></script>
  <script type="text/javascript" src="js/kmath.js"></script>
  <script type="text/javascript" src="js/audiopen.js"></script>
</body>
</html>
